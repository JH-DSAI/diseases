{# Time series chart by state - Loader/Action/Render pattern #}
{# Subscribes to MosaicState for cross-chart state filtering #}

{# Embedded JSON from server - used by loader() #}
<script type="application/json" id="timeseries-data">{{ chart_data | tojson }}</script>

<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <h3 class="card-title">Cases Over Time by State</h3>

        <div id="state-trend-chart"></div>
    </div>
</div>

<script>
(function() {
    const { loader, render } = window.StateTrendChart;

    // Parse embedded JSON
    const dataEl = document.getElementById('timeseries-data');
    if (!dataEl) return;

    const embeddedData = JSON.parse(dataEl.textContent);
    if (!embeddedData || !embeddedData.states) {
        console.warn('No timeseries data available');
        return;
    }

    // Initialize context
    const context = loader(embeddedData, '{{ disease_slug }}');

    // Current filter state
    let currentSelectedStates = new Set();
    let currentDateRange = { startDate: null, endDate: null };

    // Render function - applies both state and date filters
    function updateUI() {
        const svg = render(context, currentSelectedStates, currentDateRange);
        document.getElementById('state-trend-chart').replaceChildren(svg);
    }

    // Subscribe to state selection changes
    window.MosaicState.subscribeToStateSelection((selectedStates) => {
        currentSelectedStates = selectedStates;
        updateUI();
    });

    // Subscribe to date range changes
    window.MosaicState.subscribeToDateRange((dateRange) => {
        currentDateRange = dateRange;
        updateUI();
    });
})();
</script>
