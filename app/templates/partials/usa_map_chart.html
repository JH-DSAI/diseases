{# USA choropleth map - subscribes to MosaicState for date filtering #}

<script type="application/json" id="usa-map-data">{{ chart_data | tojson }}</script>

<!-- Tooltip element (shared across map) -->
<div id="usa-map-tooltip"
     style="position: fixed; visibility: hidden; background-color: rgba(0, 0, 0, 0.85); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 1000; max-width: 200px;">
</div>

<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <h3 class="card-title">Cases by State</h3>

        {% if chart_data.available_states %}
        <div id="usa-map-chart" class="w-full" style="min-height: 500px;">
            <div class="flex items-center justify-center h-96">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
        {% else %}
        <div class="h-64 flex items-center justify-center bg-base-200 rounded">
            <p class="text-base-content/50">No state data available for this disease</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
(function() {
    const diseaseSlug = '{{ disease_slug }}';
    const diseaseName = '{{ disease_name }}';

    // Parse embedded data
    const dataEl = document.getElementById('usa-map-data');
    if (!dataEl) return;

    let chartData = JSON.parse(dataEl.textContent);
    if (!chartData || !chartData.available_states) {
        console.warn('No map data available');
        return;
    }

    let usTopology = null;
    let isLoading = false;
    let currentSelectedStates = new Set();

    // Initialize
    async function init() {
        try {
            usTopology = await loadUSTopology();
            renderChart();

            // Subscribe to state selection changes
            window.MosaicState.subscribeToStateSelection(onStateSelectionChange);

            // Subscribe to date range changes
            window.MosaicState.subscribeToDateRange(onDateRangeChange);
        } catch (error) {
            console.error('Failed to load US topology:', error);
            const container = document.getElementById('usa-map-chart');
            if (container) {
                container.innerHTML = '<p class="text-error text-center py-8">Failed to load map data</p>';
            }
        }
    }

    function renderChart() {
        const container = document.getElementById('usa-map-chart');
        if (chartData && usTopology && container) {
            const svg = createUSAMapChart(chartData, diseaseName, usTopology, {
                highlightedStates: currentSelectedStates
            });
            container.replaceChildren(svg);
        }
    }

    function onStateSelectionChange(selectedStates) {
        currentSelectedStates = selectedStates;
        renderChart();
    }

    async function onDateRangeChange(dateRange) {
        if (isLoading) return;

        const { startDate, endDate } = dateRange;

        // If no date range set (all time), use original embedded data
        if (!startDate || !endDate) {
            chartData = JSON.parse(dataEl.textContent);
            renderChart();
            return;
        }

        // Fetch filtered data
        await fetchMapData(startDate, endDate);
    }

    async function fetchMapData(startDate, endDate) {
        isLoading = true;
        // Preserve scroll position before async operation
        const scrollY = window.scrollY;

        try {
            const formatApi = d3.timeFormat("%Y-%m-%d");
            const params = new URLSearchParams();
            params.set('start_date', formatApi(startDate));
            params.set('end_date', formatApi(endDate));

            const url = `/api/data/disease/${diseaseSlug}/state-totals?${params}`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            // Convert API response format to chart format
            chartData = {
                states: data.states,
                max_cases: data.max_cases,
                min_cases: data.min_cases,
                available_states: data.available_states
            };

            renderChart();
            // Restore scroll position after render
            requestAnimationFrame(() => {
                window.scrollTo(0, scrollY);
            });
        } catch (error) {
            console.error('Failed to fetch map data:', error);
        } finally {
            isLoading = false;
        }
    }

    init();
})();
</script>
