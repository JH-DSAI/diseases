{% extends "base.html" %}

{% block content %}
<!-- Disease Header -->
<div class="mb-8">
    <div class="breadcrumbs text-sm">
        <ul>
            <li><a href="/">Home</a></li>
            <li class="capitalize">{{ disease_name }}</li>
        </ul>
    </div>
    <h1 class="text-4xl font-bold capitalize mt-4">{{ disease_name }}</h1>
    <p class="text-lg text-base-content/70 mt-2">Detailed statistics and visualizations</p>
</div>

<!-- Disease Statistics -->
<div class="mb-8">
    <div class="stats stats-vertical lg:stats-horizontal shadow w-full"
         x-data="{ stats: null, loading: true }"
         x-init="fetch('/api/disease/{{ disease_name }}/stats', {
                     headers: {
                         'Authorization': 'Bearer ' + (localStorage.getItem('api_key') || '')
                     }
                 })
                 .then(r => r.json())
                 .then(data => {
                     stats = data;
                     loading = false;
                 })
                 .catch(err => {
                     console.error('Failed to fetch disease stats:', err);
                     loading = false;
                 })">

        <template x-if="!loading && stats">
            <div class="stat">
                <div class="stat-title">Total Cases</div>
                <div class="stat-value text-primary" x-text="stats.total_cases.toLocaleString()">-</div>
                <div class="stat-desc">All reported cases</div>
            </div>
        </template>

        <template x-if="!loading && stats">
            <div class="stat">
                <div class="stat-title">Affected Counties/Regions</div>
                <div class="stat-value text-secondary" x-text="stats.affected_counties.toLocaleString()">-</div>
                <div class="stat-desc">Geographic areas with cases</div>
            </div>
        </template>

        <template x-if="!loading && stats">
            <div class="stat">
                <div class="stat-title">Affected States/Jurisdictions</div>
                <div class="stat-value" x-text="stats.affected_states.toLocaleString()">-</div>
                <div class="stat-desc">States reporting cases</div>
            </div>
        </template>

        <template x-if="!loading && stats">
            <div class="stat">
                <div class="stat-title">Latest 2-Week Cases</div>
                <div class="stat-value text-accent" x-text="stats.two_week_cases.toLocaleString()">-</div>
                <div class="stat-desc">Recent trend</div>
            </div>
        </template>

        <template x-if="loading">
            <div class="stat">
                <div class="stat-title">Loading...</div>
                <div class="stat-value"><span class="loading loading-spinner loading-md"></span></div>
                <div class="stat-desc">Fetching statistics</div>
            </div>
        </template>
    </div>
</div>

<!-- Visualization Placeholders -->
<div class="space-y-8">
    <!-- Time Series Chart -->
    <div class="card bg-base-100 shadow-xl" x-data="diseaseChart">
        <div class="card-body">
            <div class="mb-4">
                <h3 class="card-title">Cases Over Time by State</h3>
            </div>

            <!-- State Filter -->
            <div class="mb-4" x-show="chartData !== null">
                <h4 class="text-sm font-medium mb-3">Select states to display (national total shown by default)</h4>
                <div class="filter flex flex-wrap gap-2">
                    <template x-for="state in availableStates" :key="state">
                        <input type="checkbox"
                               :class="selectedStates.includes(state) ? 'btn btn-sm btn-primary' : 'btn btn-sm'"
                               :aria-label="state"
                               :value="state"
                               x-model="selectedStates"
                               @change="renderChart()">
                    </template>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="flex items-center justify-center h-96">
                <span class="loading loading-spinner loading-lg"></span>
            </div>

            <!-- Error State -->
            <div x-show="error && !loading" class="alert alert-error">
                <span x-text="error"></span>
            </div>

            <!-- Chart Container -->
            <div id="diseaseStateTrendChart" class="w-full" x-show="!loading && !error" style="min-height: 450px;"></div>
        </div>
    </div>

    <!-- Geographic and Demographic Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Age Distribution -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title">Age Group Distribution</h3>
                <div class="h-64 flex items-center justify-center bg-base-200 rounded">
                    <p class="text-base-content/50">Coming soon: Age distribution bar chart</p>
                </div>
            </div>
        </div>

        <!-- Geographic Breakdown -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title">Geographic Breakdown</h3>
                <div class="h-64 flex items-center justify-center bg-base-200 rounded">
                    <p class="text-base-content/50">Coming soon: Regional comparison</p>
                </div>
            </div>
        </div>
    </div>

    {% if disease_name == 'meningococcus' %}
    <!-- Serotype Analysis (Meningococcus only) -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h3 class="card-title">Serotype Distribution</h3>
            <div class="h-64 flex items-center justify-center bg-base-200 rounded">
                <p class="text-base-content/50">Coming soon: Serotype pie chart</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Back to Home -->
<div class="mt-8">
    <a href="/" class="btn btn-outline">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Home
    </a>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/disease-state-trend-chart.js"></script>
<script>
    // Register component immediately - Alpine will pick it up when it starts
    if (window.Alpine) {
        Alpine.data('diseaseChart', diseaseChartComponent);
    } else {
        document.addEventListener('alpine:init', () => {
            Alpine.data('diseaseChart', diseaseChartComponent);
        });
    }

    function diseaseChartComponent() {
        return {
            chartData: null,
            selectedStates: [],
            availableStates: [],
            loading: true,
            error: null,

            init() {
                console.log('Chart component initialized');
                this.loadData();
            },

            async loadData() {
                console.log('Loading data for {{ disease_name }}');
                try {
                    const response = await fetch(`/api/timeseries/states/{{ disease_name }}?granularity=month`);
                    console.log('Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    this.chartData = await response.json();
                    console.log('Chart data loaded:', this.chartData);

                    this.availableStates = this.chartData.available_states;
                    this.selectedStates = [...this.availableStates];
                    this.loading = false;

                    // Wait for Alpine to update the DOM before rendering
                    this.$nextTick(() => {
                        requestAnimationFrame(() => this.renderChart());
                    });
                } catch (err) {
                    console.error('Error loading disease data:', err);
                    this.error = 'Failed to load chart data';
                    this.loading = false;
                }
            },

            renderChart() {
                console.log('Rendering chart');
                if (!this.chartData) {
                    console.warn('No chart data available');
                    return;
                }

                createDiseaseStateTrendChart(
                    'diseaseStateTrendChart',
                    this.chartData,
                    '{{ disease_name }}',
                    this.selectedStates
                );
            }
        }
    }
</script>
{% endblock %}
